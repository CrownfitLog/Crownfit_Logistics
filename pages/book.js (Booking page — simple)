// pages/book.js
import { useState } from 'react';
import { v4 as uuidv4 } from 'uuid';

export default function Book() {
  const [loading, setLoading] = useState(false);
  const [result, setResult] = useState(null);
  const [form, setForm] = useState({
    sender_name: '', sender_phone: '', sender_address: '',
    sender_lat: '', sender_lng: '',
    recipient_name: '', recipient_phone:'', recipient_address: '',
    recipient_lat:'', recipient_lng:'', service_type: 'end_to_end', weight_kg: 1
  });

  const onChange = (k, v) => setForm(s => ({...s, [k]: v}));

  async function submit(e) {
    e.preventDefault();
    setLoading(true);
    setResult(null);
    const payload = {
      sender: {
        name: form.sender_name, phone: form.sender_phone, address: form.sender_address,
        coords: (form.sender_lat && form.sender_lng) ? {lat: Number(form.sender_lat), lng: Number(form.sender_lng)} : null
      },
      recipient: {
        name: form.recipient_name, phone: form.recipient_phone, address: form.recipient_address,
        coords: (form.recipient_lat && form.recipient_lng) ? {lat: Number(form.recipient_lat), lng: Number(form.recipient_lng)} : null
      },
      service_type: form.service_type,
      weight_kg: Number(form.weight_kg),
    };

    const res = await fetch('/api/bookings', { method: 'POST', headers: {'content-type':'application/json'}, body: JSON.stringify(payload) });
    const j = await res.json();
    setResult(j);
    setLoading(false);
  }

  return (
    <div className="min-h-screen flex items-center justify-center bg-gray-50 p-6">
      <form onSubmit={submit} className="w-full max-w-3xl bg-white p-6 rounded shadow space-y-4">
        <h2 className="text-xl font-bold">Create Booking</h2>

        <div className="grid grid-cols-2 gap-4">
          <div>
            <label className="block text-sm font-medium">Sender name</label>
            <input value={form.sender_name} onChange={(e)=>onChange('sender_name', e.target.value)} className="mt-1 w-full border p-2 rounded"/>
            <label className="block text-sm font-medium mt-2">Sender phone</label>
            <input value={form.sender_phone} onChange={(e)=>onChange('sender_phone', e.target.value)} className="mt-1 w-full border p-2 rounded"/>
            <label className="block text-sm font-medium mt-2">Sender address (human readable)</label>
            <input value={form.sender_address} onChange={(e)=>onChange('sender_address', e.target.value)} className="mt-1 w-full border p-2 rounded" placeholder="e.g., 100 Main St, Dallas, TX"/>
            <div className="text-xs text-gray-500">Optional: enter latitude/longitude if you don't have Google API set up</div>
            <div className="flex gap-2 mt-1">
              <input value={form.sender_lat} onChange={(e)=>onChange('sender_lat', e.target.value)} placeholder="lat" className="w-1/2 border p-2 rounded"/>
              <input value={form.sender_lng} onChange={(e)=>onChange('sender_lng', e.target.value)} placeholder="lng" className="w-1/2 border p-2 rounded"/>
            </div>
          </div>

          <div>
            <label className="block text-sm font-medium">Recipient name</label>
            <input value={form.recipient_name} onChange={(e)=>onChange('recipient_name', e.target.value)} className="mt-1 w-full border p-2 rounded"/>
            <label className="block text-sm font-medium mt-2">Recipient phone</label>
            <input value={form.recipient_phone} onChange={(e)=>onChange('recipient_phone', e.target.value)} className="mt-1 w-full border p-2 rounded"/>
            <label className="block text-sm font-medium mt-2">Recipient address</label>
            <input value={form.recipient_address} onChange={(e)=>onChange('recipient_address', e.target.value)} className="mt-1 w-full border p-2 rounded" placeholder="e.g., 200 Elm St, Austin, TX"/>
            <div className="text-xs text-gray-500">Optional: enter latitude/longitude</div>
            <div className="flex gap-2 mt-1">
              <input value={form.recipient_lat} onChange={(e)=>onChange('recipient_lat', e.target.value)} placeholder="lat" className="w-1/2 border p-2 rounded"/>
              <input value={form.recipient_lng} onChange={(e)=>onChange('recipient_lng', e.target.value)} placeholder="lng" className="w-1/2 border p-2 rounded"/>
            </div>
          </div>
        </div>

        <div className="grid grid-cols-3 gap-4">
          <select value={form.service_type} onChange={(e)=>onChange('service_type', e.target.value)} className="border p-2 rounded">
            <option value="pickup">Pickup</option>
            <option value="delivery">Delivery</option>
            <option value="end_to_end">End-to-end</option>
          </select>
          <input type="number" value={form.weight_kg} onChange={(e)=>onChange('weight_kg', e.target.value)} className="border p-2 rounded" placeholder="weight kg"/>
          <button disabled={loading} className="col-span-1 bg-green-600 text-white px-4 py-2 rounded">
            {loading ? 'Booking...' : 'Book'}
          </button>
        </div>

        {result && (
          <div className="mt-4 p-4 bg-gray-100 rounded">
            <pre className="text-sm">{JSON.stringify(result, null, 2)}</pre>
          </div>
        )}
      </form>
    </div>
  );
}
